<!DOCTYPE html>
<html lang="zh-cn">
  <head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noodp"/>
  <meta name="author" content="anfieldqi">
  
  
  
  <link rel="prev" href="http://anfieldqi.top/2020/firmfuzz/" />
  <link rel="next" href="http://anfieldqi.top/2020/firmcorn/" />
  <link rel="canonical" href="http://anfieldqi.top/2020/firmdyne/" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
  <title>
       
       
           论文:Firmdyne | AnfieldQi`s Blog
       
  </title>
  <meta name="title" content="论文:Firmdyne | AnfieldQi`s Blog">
    
  
  <link rel="stylesheet" href="/font/iconfont.css">
  <link rel="stylesheet" href="/css/main.min.css">


  
  
 

<script type="application/ld+json">
 "@context" : "http://schema.org",
    "@type" : "BlogPosting",
    "mainEntityOfPage": {
         "@type": "WebPage",
         "@id": "http:\/\/anfieldqi.top"
    },
    "articleSection" : "posts",
    "name" : "论文:Firmdyne",
    "headline" : "论文:Firmdyne",
    "description" : "1.题目 Towards Automated Dynamic Analysis forLinux-based Embedded Firmware 2.主要内容 2.1 论文内容 针对市场上嵌入式设备固件种类繁多，严重影响模拟动态分析执行的问题，本文提出了一个不依赖于物理设备",
    "inLanguage" : "zh-cn",
    "author" : "anfieldqi",
    "creator" : "anfieldqi",
    "publisher": "anfieldqi",
    "accountablePerson" : "anfieldqi",
    "copyrightHolder" : "anfieldqi",
    "copyrightYear" : "2020",
    "datePublished": "2020-09-16 16:22:55 \x2b0800 CST",
    "dateModified" : "2020-09-16 16:22:55 \x2b0800 CST",
    "url" : "http:\/\/anfieldqi.top\/2020\/firmdyne\/",
    "wordCount" : "3501",
    "keywords" : [ "IoT", "AnfieldQi`s Blog"]
}
</script>

</head>

  


  <body class="">
    <div class="wrapper">
        <nav class="navbar">
    
    <div class="top-scroll-bar"></div>
    
    <div class="container">
        <div class="navbar-header header-logo">
        	<a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href="http://anfieldqi.top">AnfieldQi`s Blog</a>
        </div>
        <div class="menu navbar-right">
                
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
                <a class="menu-item" href="/categories/" title="">Categories</a>
                
                <a class="menu-item" href="/tags/" title="">Tags</a>
                
                <a class="menu-item" href="/about/" title="">About</a>
                
        </div>
    </div>
</nav>
<nav class="navbar-mobile" id="nav-mobile" style="display: none">
    
        <div class="top-scroll-bar"></div>
    
     <div class="container">
        <div class="navbar-header">
            <div>  <a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href="http://anfieldqi.top">AnfieldQi`s Blog</a></div>
            <div class="menu-toggle">
                <span></span><span></span><span></span>
            </div>
        </div>
     
          <div class="menu" id="mobile-menu">
                
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
                <a class="menu-item" href="/categories/" title="">Categories</a>
                
                <a class="menu-item" href="/tags/" title="">Tags</a>
                
                <a class="menu-item" href="/about/" title="">About</a>
                
        </div>
    </div>
</nav>
    	 <main class="main">
          <div class="container">
      		
<article class="post-warp" itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
        <h1 class="post-title" itemprop="name headline">论文:Firmdyne</h1>
        <div class="post-meta">
                Written by <a itemprop="name" href="http://anfieldqi.top" rel="author">anfieldqi</a> with ♥ 
                <span class="post-time">
                on <time datetime=2020-09-16 itemprop="datePublished">September 16, 2020</time>
                </span>
                in
                <i class="iconfont icon-folder"></i>
                <span class="post-category">
                        <a href="http://anfieldqi.top/categories/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0/"> 论文笔记 </a>
                        
                </span>
                <span class="post-word-count">, 3501 words</span>
        </div>
    </header>
    <div class="post-content">
        

        
            
        

        
        
     
          
          
          

          
          
          

          <h3 id="1题目">1.题目</h3>
<p>Towards Automated Dynamic Analysis forLinux-based Embedded Firmware</p>
<h3 id="2主要内容">2.主要内容</h3>
<h4 id="21-论文内容">2.1 论文内容</h4>
<p>针对市场上嵌入式设备固件种类繁多，严重影响模拟动态分析执行的问题，本文提出了一个不依赖于物理设备的全系统仿真自动动态分析系统，其针对基于linux系统的固件，核心要点如下：1.给出了一套相对完备的固件仿真方案，2.给出了测试过程中如何处理外围设备的交互的方案 3.进行了简单的遍历测试，不过没有进行fuzz</p>
<h4 id="22-作者的contribution">2.2 作者的contribution</h4>
<ol>
<li>介绍了FIRMADYNE，它是一种自动化和可扩展的动态分析技术的实现，专门设计用于准确识别基于Linux的嵌入式固件中的漏洞</li>
<li>解决了嵌入式系统的特点挑战，如硬件特定外设的存在、非易失性内存（NVRAM）的使用以及动态生成文件的创建</li>
<li>收集了从42家不同供应商下载的23035个固件映像的数据集，并使用一组14个以前未知的漏洞和60个已知漏洞（第五节）对成功提取的9486个固件映像进行了FIRMADYNE评估</li>
<li>开源了整个项目的技术细节</li>
</ol>
<h3 id="3-3-已有研究">3 3. 已有研究</h3>
<ol>
<li>Zaddach[19]走了avatar那条路线，也就是将物理设备与仿真部分结合，在测试过程中进行上下文状态的转发。这种方法的优点是比较精确，缺点是如果用于大规模分析的话成本较高，对于每次测试都需要物理设备的存在</li>
<li>Costin[8]利用静态分析技术来解压固件并对其中的二进制文件进行分析。此种分析手法受到嵌入式固件的制约，分析的结果会产生很多误报，同时静态分析技术通常针对特定的语言，但是固件中往往是多种语言脚本的合集</li>
</ol>
<h3 id="4技术背景">4.技术背景</h3>
<ol>
<li>一个完整的系统仿真，需要正确的配置仿真环境与仿真固件的网络接口交互，<strong>这是进行后续研究的基础</strong></li>
<li>固件程序需要与外围设备进行交互，但是仿真环境无法提供此类外围设备，需要进行处理。</li>
</ol>
<h4 id="41-针对固件的动态分析">4.1 针对固件的动态分析</h4>
<ol>
<li>**应用级别模拟：**最直接的方法是通过工具拿到固件镜像，再通过将其放到可提供支持的物理设备中进行运行。ps:这与寻求为嵌入式固件分析创建通用平台的思路不符，单纯静态的分析与web相关的脚本等文件效率不高，而且存在很多自定义的处理逻辑</li>
<li><strong>单进程模拟</strong>：此种方法在原始文件系统的上下文中模拟单个进程的行为，通过在用户态作为单个进程仿真器执行QEMU来实现，并使用chroot切换到原始文件系统，再启动web服务器，该过程模拟了路由器web接口.PS:这种方法在程序需要访问外围设备时将变的不适用。举个例子：这种寻找脚本启动的方法，lighttpd启动时需要传参，如果不给，那么模拟失败。但是我们不可能每个固件都去看它开启的策略是什么</li>
<li><strong>全系统模拟</strong>：在全系统模拟的情况下，除了没有真正的外围设备，固件程序所有与外围系统相关的接口都准备好，当仿真程序需要与外围设备交互时，通过相关策略模拟伪交互，返回伪状态，在一定程度上满足了交互需求。</li>
</ol>
<h3 id="5-分析框架设计">5. 分析框架设计</h3>
<p><img src="/images/firmadyne.png" alt=""></p>
<p><img src="../../../../static/images/firmadyne.png" alt="~"></p>
<ol>
<li>使用爬虫爬取固件，整理数据集</li>
<li>提取固件文件系统：使用binwalk api构建自定义程序来提取固件映像中包含的内核和文件系统</li>
<li>初次模拟：文件系统提取成功后，将会识别硬件架构并在QEMU全系统仿真器中使用预构建的linux内核，执行初始仿真以推断系统和网络设置（通过监控文件系统，网络和其他相关内核子系统的系统调用来实现，看了下源码实际上就是抓取一下web交互界面的和端口提供给动态分析部分）</li>
<li>动态分析：动态的重新配置环境，并开始漏洞检测模块（该工具主要关注点不在这，只是简单的建立了几个常规的漏洞发现策略）</li>
</ol>
<h4 id="51-固件收集">5.1 固件收集</h4>
<p>使用scrapy框架开发了一款爬虫工具。为每个厂商定制了爬取策略。目前数据集依然公开，这是我们目前研究的目标数据集，接下来的研究都会根据此数据集展开。</p>
<h4 id="52-固件提取">5.2 固件提取</h4>
<p>使用binwalk api开发一个定制的目标驱动的提取实用程序，然后通过一组启发式算法来筛选数据集中非固件文件（主要是通过文件类型判别，否则会显示为需要递归提取的压缩文档），<strong>非固件文件过滤成功后通过使用一组判别特征进行排序（相比于binwalk的看见压缩的就递归解压策略好很多）</strong>，通过检查文件系统的层次结构判断文件系统是否提取成功。</p>
<h4 id="53-固件仿真">5.3 固件仿真</h4>
<h5 id="1理论基础">1.理论基础</h5>
<ol>
<li>至少52.6%的提取固件映像（9486个映像中有4992个）<strong>使用一个名为libnvram.so持久化特定于设备的配置参数</strong>，于路由器和其他网络设备，这包括基于web的配置界面上显示的设置，其中可以包括无线网络设置、网络适配器MAC地址和web接口的访问凭据，在这种策略中外围设备抽象为key:value的形式存储，<strong>当程序需要与外围设备交互时，会设置调用NVRAM中持久化存储的用于外围设备的相关方法参数，完成对外围设备的设置或状态查询</strong></li>
<li><strong>LD_PRELOAD</strong>是Linux系统的一个环境变量，它可以影响程序的运行时的链接（Runtime linker），它允许你定义在程序运行前优先加载的动态链接库。这个功能主要就是用来有选择性的载入不同动态链接库中的相同函数。通过这个环境变量，我们可以在主程序和其动态链接库的中间加载别的动态链接库，甚至覆盖正常的函数库。一方面，我们可以以此功能来使用自己的或是更好的函数（无需别人的源码），而另一方面，也可以以向别人的程序注入程序，从而达到特定的目的。</li>
<li>NVRAM中持久化特定于设备的配置参数时需要有一组特定于系统的默认值以便其进行初始化</li>
<li>内核方面：ARM和MIPS架构内核总共占数据集的90.8%（因此只定制化这两个）</li>
</ol>
<h5 id="2仿真手段">2.仿真手段</h5>
<p>对于网络的模拟：</p>
<ol>
<li>
<p>系统最初在“学习”阶段执行每个模拟固件60秒。在这个阶段，模拟器配置了模拟目标平台（MIPS Malta或ARM Virtual Express）的默认硬件外围设备，以及最多四个模拟网络适配器，使用QEMU内的内置套接字网络后端。在此期间，将收集有关预期网络配置的信息。跟踪分配给网络接口的IP地址，以及用于聚合多个网络接口的ieee802.1d网桥。此外，使用ieee802.1qvlan检查以太网帧的标记和分离，一些路由器使用该vlan将无线仿真网络与物理网络隔离开来。</p>
</li>
<li>
<p>然后将这些信息反馈到仿真框架中，为这个系统开发更精确的QEMU配置。在主机上实例化一个network tap（tap）设备，它与对应于LAN接口的固件（例如eth0）中的一个仿真网络接口相关联。对于使用VLAN的固件映像，我们为TAP接口分配一个相应的VLAN ID，以便与模拟的网络服务成功通信。接下来，TAP接口配置一个IP地址，该地址与固件分配给仿真接口的IP地址位于同一个子网中**（实质为QEMU手动搭桥的自动化，此部分我们已经实验成功）**最后，通过发送ICMP请求并使用Nmap[3]实用程序执行端口扫描来检查网络连接</p>
</li>
</ol>
<p>对于外围设备交互：</p>
<ol>
<li>
<p>定制内核：在内核编译过程中，在定制的Linux内核模块中实现了分析，该模块用于帮助调试和模拟原始系统环境。通过使用内核动态探测器挂接20个系统调用（kprobes）框架，能够拦截改变执行环境的调用。这包括分配MAC地址、创建网桥、重新启动系统和执行程序等操作，所有这些操作都由框架监控，以正确配置模拟的网络环境</p>
</li>
<li>
<p>核心技术图示（图文无关）</p>
<p><img src="/images/ld_prload.png" alt=""></p>
</li>
</ol>
<p><!-- raw HTML omitted --></p>
<h4 id="54-固件自动化分析">5.4 固件自动化分析</h4>
<p>关注点不在此部分，作者也只用了数据库漏洞匹配和手动分析来简单做了一下，不准备采纳其方法，在此不做叙述</p>
<h3 id="7实验过程">7.实验过程</h3>
<h4 id="71-数据集">7.1 数据集</h4>
<p>web爬虫爬来的涉及不同运营商拿来的经过过滤的8617个真实固件镜像</p>
<h4 id="72-实验结论">7.2 实验结论</h4>
<p>在识别出的8617个固件映像中，系统最初成功地模拟了96.6%（8591）</p>
<p>在进入“学习”阶段的8591个固件映像中，只有32.3%（2797）成功推断了它们的网络配置</p>
<p>在2797个推测网络配置的映像中，只有70.8%（1971年）可以使用ping从网络访问</p>
<h3 id="8与其他比较">8.与其他比较</h3>
<p>无</p>
<h3 id="9可继续研究的点">9.可继续研究的点</h3>
<ol>
<li>数据集中镜像充足，可以结合静态分析，通过静态分析的结果引导动态分析</li>
<li>在固件提取方面，<strong>统计分析技术可以用来改进框架的固件提取组件。<strong>可能会通过单独的提取路径处理出现混淆或加密的固件映像。例如，众所周知，Buffalo LinkStation设备的固件是加密的，但是密码和解密实用程序是公开的</strong>（interesting）</strong></li>
<li>在对外围设备的处理上，目前的策略是替换使用的库，对所有外围设备的查询或者处理都统一设定状态返回值True，但是实际中这种会存在很大的弊端，举个例子，虽然固件均<strong>使用一个名为libnvram.so持久化特定于设备的配置参数</strong>，但是不同设备的处理细节可不同，并非所有查询都需要返回TRUE，这种返回会造成程序崩溃，因此有两个方向，如何去处理这种特例（可行性不大，文中给出的方案是手动去看），如何避免引起的崩溃不影响接下来的测试（即涉及一套机制使程序在崩溃的状态返回，或者说回到未崩溃的状态）</li>
</ol>
<h3 id="9开源信息">9.开源信息</h3>
<p><a href="https://github.com/firmadyne/firmadyne">https://github.com/firmadyne/firmadyne</a></p>

    </div>

    <div class="post-copyright">
             
            <p class="copyright-item">
                <span>Author:</span>
                <span>anfieldqi </span>
                </p>
            
           
             
            <p class="copyright-item">
                    <span>Link:</span>
                    <a href=http://anfieldqi.top/2020/firmdyne/>http://anfieldqi.top/2020/firmdyne/</span>
            </p>
            
             
            <p class="copyright-item lincese">
                除特别标注，文章采用<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可
            </p>
            
    </div>

  
    <div class="post-tags">
        
            <section>
            <i class="iconfont icon-tag"></i>Tag(s): 
            
            <span class="tag"><a href="http://anfieldqi.top/tags/iot/">
                    #IoT</a></span>
            
            </section>
        
        <section>
                <a href="javascript:window.history.back();">back</a></span> · 
                <span><a href="http://anfieldqi.top">home</a></span>
        </section>
    </div>

    <div class="post-nav">
        
        <a href="http://anfieldqi.top/2020/firmfuzz/" class="prev" rel="prev" title="论文:FirmFuzz:Automated IoT Firmware Introspection and Analysis"><i class="iconfont icon-left"></i>&nbsp;论文:FirmFuzz:Automated IoT Firmware Introspection and Analysis</a>
         
        
        <a href="http://anfieldqi.top/2020/firmcorn/" class="next" rel="next" title="论文:FirmCorn: Vulnerability-Oriented Fuzzing of IoT Firmware">论文:FirmCorn: Vulnerability-Oriented Fuzzing of IoT Firmware&nbsp;<i class="iconfont icon-right"></i></a>
        
    </div>

    <div class="post-comment">
          
                 
          
          
<div id="gitalk-container"></div>
<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
<script>
  const gitalk = new Gitalk({
    clientID: '10430486a804bdce5dd3',
    clientSecret: 'b8c2e27fc2de4a7e7f9e80094cebbf2601134eea',
    repo: 'AnfieldQi.github.io',
    owner: 'AnfieldQi',
    admin: ['AnfieldQi'],
    id: location.pathname, 
    distractionFreeMode: false 
  });
  (function() {
    if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
      document.getElementById('gitalk-container').innerHTML = 'Gitalk comments not available by default when the website is previewed locally.';
      return;
    }
    gitalk.render('gitalk-container');
  })();
</script>

    </div>
</article>
          </div>
		   </main>
      <footer class="footer">
    <div class="copyright">
        &copy;
        
        <span itemprop="copyrightYear">2019 - 2020</span>
        
        <span class="with-love">
    	 <i class="iconfont icon-love"></i> 
         </span>
         
            <span class="author" itemprop="copyrightHolder"><a href="http://anfieldqi.top">anfieldqi</a> | </span> 
         

         
            <a href="http://www.beian.miit.gov.cn/" target="_blank" rel="external nofollow">京ICP备20032128号 </a> |
         
		  <span>power by <a href="https://gohugo.io/" target="_blank" rel="external nofollow">Hugo</a> </span> 
    </div>
</footer>













    
     <link href="//lib.baomitu.com/lightgallery/1.6.11/css/lightgallery.min.css" rel="stylesheet">  
      
     <script src="/js/vendor_gallery.min.js" async="" ></script>
    
  



     </div>
  </body>
</html>
