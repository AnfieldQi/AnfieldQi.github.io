<!DOCTYPE html>
<html lang="zh-cn">
  <head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noodp"/>
  <meta name="author" content="anfieldqi">
  
  
  
  <link rel="prev" href="https://anfieldqi.github.io/2020/shell%E5%AD%A6%E4%B9%A0/" />
  <link rel="next" href="https://anfieldqi.github.io/2020/python%E5%B5%8C%E5%A5%97%E5%87%BD%E6%95%B0/" />
  <link rel="canonical" href="https://anfieldqi.github.io/2020/python%E8%A3%85%E9%A5%B0%E5%99%A8/" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
  <title>
       
       
           Python装饰器 | AnfieldQi`s Blog
       
  </title>
  <meta name="title" content="Python装饰器 | AnfieldQi`s Blog">
    
  
  <link rel="stylesheet" href="/font/iconfont.css">
  <link rel="stylesheet" href="/css/main.min.css">


  
  
 

<script type="application/ld+json">
 "@context" : "http://schema.org",
    "@type" : "BlogPosting",
    "mainEntityOfPage": {
         "@type": "WebPage",
         "@id": "https:\/\/anfieldqi.github.io"
    },
    "articleSection" : "posts",
    "name" : "Python装饰器",
    "headline" : "Python装饰器",
    "description" : "Python装饰器 1.概念 装饰器是可调用的对象，其参数是另外一个函数，装饰器可能会处理被装饰的函数然后把它返回，或者将其替换成另外一个函数或",
    "inLanguage" : "zh-cn",
    "author" : "anfieldqi",
    "creator" : "anfieldqi",
    "publisher": "anfieldqi",
    "accountablePerson" : "anfieldqi",
    "copyrightHolder" : "anfieldqi",
    "copyrightYear" : "2020",
    "datePublished": "2020-04-16 21:52:36 \x2b0800 CST",
    "dateModified" : "2020-04-16 21:52:36 \x2b0800 CST",
    "url" : "https:\/\/anfieldqi.github.io\/2020\/python%E8%A3%85%E9%A5%B0%E5%99%A8\/",
    "wordCount" : "2740",
    "keywords" : [ "python基础", "AnfieldQi`s Blog"]
}
</script>

</head>

  


  <body class="">
    <div class="wrapper">
        <nav class="navbar">
    
    <div class="top-scroll-bar"></div>
    
    <div class="container">
        <div class="navbar-header header-logo">
        	<a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href="https://anfieldqi.github.io">AnfieldQi`s Blog</a>
        </div>
        <div class="menu navbar-right">
                
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
                <a class="menu-item" href="/categories/" title="">Categories</a>
                
                <a class="menu-item" href="/tags/" title="">Tags</a>
                
                <a class="menu-item" href="/about/" title="">About</a>
                
        </div>
    </div>
</nav>
<nav class="navbar-mobile" id="nav-mobile" style="display: none">
    
        <div class="top-scroll-bar"></div>
    
     <div class="container">
        <div class="navbar-header">
            <div>  <a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href="https://anfieldqi.github.io">AnfieldQi`s Blog</a></div>
            <div class="menu-toggle">
                <span></span><span></span><span></span>
            </div>
        </div>
     
          <div class="menu" id="mobile-menu">
                
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
                <a class="menu-item" href="/categories/" title="">Categories</a>
                
                <a class="menu-item" href="/tags/" title="">Tags</a>
                
                <a class="menu-item" href="/about/" title="">About</a>
                
        </div>
    </div>
</nav>
    	 <main class="main">
          <div class="container">
      		
<article class="post-warp" itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
        <h1 class="post-title" itemprop="name headline">Python装饰器</h1>
        <div class="post-meta">
                Written by <a itemprop="name" href="https://anfieldqi.github.io" rel="author">anfieldqi</a> with ♥ 
                <span class="post-time">
                on <time datetime=2020-04-16 itemprop="datePublished">April 16, 2020</time>
                </span>
                in
                <i class="iconfont icon-folder"></i>
                <span class="post-category">
                        <a href="https://anfieldqi.github.io/categories/python/"> python </a>
                        
                </span>
                <span class="post-word-count">, 2740 words</span>
        </div>
    </header>
    <div class="post-content">
        

        

        
        
     
          
          
          

          
          
          

          <h3 id="python装饰器">Python装饰器</h3>
<h4 id="1概念">1.概念</h4>
<p>装饰器是可调用的对象，其参数是另外一个函数，装饰器可能会处理被装饰的函数然后把它返回，或者将其替换成另外一个函数或者可调用对象。</p>
<h4 id="一等函数">一等函数</h4>
<h6 id="函数是一等对象满足以下条件">函数是一等对象，满足以下条件</h6>
<ol>
<li>在运行时创建</li>
<li>能赋值给变量或者数据结构中的元素</li>
<li>能作为承诺书传给参数</li>
<li>能作为函数的返回结果</li>
</ol>
<h6 id="一个简单函数的定义">一个简单函数的定义：</h6>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">hello</span>():    
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Hello world!&#34;</span>)
</code></pre></div><p>python解释器遇到这段代码时：</p>
<ol>
<li>编译生成一个函数对象</li>
<li>将名为hello的名字绑定到对象上</li>
</ol>
<p>在python中，函数作为一等对象，可以向int string float一样作为参数或返回值</p>
<h4 id="函数作为参数">函数作为参数</h4>
<p>例：函数call_foo_with_arg 返回两个函数，一个是函数对象foo</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">foo</span>(bar):
     <span style="color:#66d9ef">return</span> bar <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
     <span style="color:#66d9ef">print</span>(foo)
     <span style="color:#66d9ef">print</span>(foo(<span style="color:#ae81ff">2</span>))
     <span style="color:#66d9ef">print</span>(type(foo))
     
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">call_foo_with_arg</span>(foo, arg):
    <span style="color:#66d9ef">return</span> foo(arg)
    
<span style="color:#66d9ef">print</span>(call_foo_with_arg(foo, <span style="color:#ae81ff">3</span>))
</code></pre></div><h4 id="嵌套函数">嵌套函数</h4>
<p>函数也可以定义在另外一个函数中，作为嵌套函数</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">parent</span>():  
      <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Printing from the parent() function.&#34;</span>)    
      
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">first_child</span>():
     <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;Printing from the first_child() function.&#34;</span>   
     
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">second_child</span>():       
     <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;Printing from the second_child() function.&#34;</span>    
     
     
 <span style="color:#66d9ef">print</span>(first_child())    
 <span style="color:#66d9ef">print</span>(second_child())
</code></pre></div><p>first_child 和 second_child 函数是嵌套在 parent 函数中的函数。</p>
<p>当调用 parent 函数时，内嵌的first_child 和 second_child 函数也被调用，但是如果在 parent 函数中并不是调用first_child 和 second_child 函数， 而是返回这两个函数对象时：</p>
<h3 id="变量作用域">变量作用域</h3>
<p>首先介绍变量作用域，关于作用域的详细内容初学者可结合另一篇博文学习</p>
<p>Python是动态语言，Python的变量名解析机制有时称为LEGB法则，当在函数中使用未认证的变量名时，Python搜索4个作用域：</p>
<p><strong>L&ndash;&gt;E&ndash;&gt;G&ndash;&gt;B原则：</strong></p>
<ol>
<li>local 函数内部作用域</li>
<li>enclosing 函数内部与内嵌函数之间</li>
<li>global 全局作用域</li>
<li>build-in 内置作用域</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">f1</span>(a):   
    <span style="color:#66d9ef">print</span>(a)    
    <span style="color:#66d9ef">print</span>(b)f1(<span style="color:#ae81ff">3</span>)
    
</code></pre></div><p>这段程序会抛出错误：”NameError: name ‘b’ is not defined”，这是因为在函数体内，Python编译器搜索上面 LEGB 的变量，没有找到。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">
b <span style="color:#f92672">=</span> <span style="color:#ae81ff">6</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">f2</span>(a):
    <span style="color:#66d9ef">print</span>(a)
    <span style="color:#66d9ef">print</span>(b)
    b <span style="color:#f92672">=</span> <span style="color:#ae81ff">9</span>
    
f2(<span style="color:#ae81ff">3</span>)
</code></pre></div><p>在Python中，Python不要求声明变量，但是<!-- raw HTML omitted -->假定在函数体中被赋值的变量是局部变量<!-- raw HTML omitted -->，所以在这个函数体中，变量b被判断成局部变量，所以在print(b)调用时会抛出 “UnboundLocalError: local variable ‘b’ referenced before assignment” 的错误。</p>
<p>要想上面的代码运行，就必须手动在函数体内声明变量b为全局变量</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">
b <span style="color:#f92672">=</span> <span style="color:#ae81ff">6</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">f2</span>(a):
   <span style="color:#66d9ef">global</span> b
   <span style="color:#66d9ef">print</span>(a)
   <span style="color:#66d9ef">print</span>(b)
   b <span style="color:#f92672">=</span> <span style="color:#ae81ff">9</span>
   
 f2(<span style="color:#ae81ff">3</span>)
</code></pre></div><h3 id="闭包">闭包</h3>
<p>闭包是指延伸了作用域的函数。
例子：现在有个avg函数，用于计算不断增长的序列的平均值。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">make_averager</span>():   
         series <span style="color:#f92672">=</span> []   
         <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">averager</span>(new_value):        
                   series<span style="color:#f92672">.</span>append(new_value)        
                   total <span style="color:#f92672">=</span> sum(series)        
                   <span style="color:#66d9ef">return</span> total <span style="color:#f92672">/</span> len(series)    
         <span style="color:#66d9ef">return</span> averager
         
 avg <span style="color:#f92672">=</span> make_averager()
 avg(<span style="color:#ae81ff">10</span>)
 avg(<span style="color:#ae81ff">11</span>)
</code></pre></div><p>调用函数 make_averager 时候，返回一个 averager 函数对象，每次调用 averager 函数，会把参数添加到 series 中，然后计算当前平均值。</p>
<p>series 是 make_averager 函数的局部变量，调用 avg(10) 时， make_averager 函数已经返回，所以本地作用域也就不存在了。但是在 averager 函数中，series 是自由变量</p>
<p><strong>这里的 avg 就是一个闭包，本质上它还是函数，闭包是引用了自由变量(series)的函数(averager)</strong></p>
<h3 id="nonlocal声明">nonlocal声明</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">make_averager</span>():    
       count <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>    
       total <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>    
       <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">averager</span>(new_value):      
                 count <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>       
                 total <span style="color:#f92672">+=</span> new_value        
                 <span style="color:#66d9ef">return</span> total <span style="color:#f92672">/</span> count    
             
       <span style="color:#66d9ef">return</span> averager
       
 avg <span style="color:#f92672">=</span> make_averager()
 avg(<span style="color:#ae81ff">10</span>)
</code></pre></div><p>这时候会抛出错误 “UnboundLocalError: local variable ‘count’ referenced before assignment”。这是因为：当count为数字或者任何不可变类型时，在函数体定义中 count = count + 1 实际上是为count赋值，所以count就变成了局部变量。为了避免这个问题，python3引入了 nonlocal 声明，作用是把变量标记成 自由变量</p>
<h3 id="装饰器">装饰器</h3>
<p>了解了闭包，可以用嵌套函数实现装饰器
装饰器时一种闭包的应用，传递的时函数</p>
<h4 id="被修饰的函数无参">被修饰的函数无参</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">makebold</span>(fn):  
     <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">wrapped</span>():     
           <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;&lt;b&gt;&#39;</span> <span style="color:#f92672">+</span> fn() <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;&lt;/b&gt;&#39;</span>   
     
    <span style="color:#66d9ef">return</span> wrapped
    
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">makeitalic</span>(fn):    
     <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">wrapped</span>():        
             <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;&lt;i&gt;&#39;</span> <span style="color:#f92672">+</span> fn() <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;&lt;/i&gt;&#39;</span>   
              
      <span style="color:#66d9ef">return</span> wrapped
      
 <span style="color:#a6e22e">@makebold</span>
 <span style="color:#a6e22e">@makeitalic</span>
 <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">hello</span>():    
       <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;Hello World&#34;</span>
       <span style="color:#66d9ef">print</span>(hello())
</code></pre></div><p>makeitalic 装饰器将函数 hello 传递给函数 makeitalic，函数 makeitalic 执行完毕后返回被包装后的 hello 函数，而这个过程其实就是通过闭包实现的</p>
<p>装饰器有一个语法糖@,直接@my_new_decorator就把上面一坨代码轻松化解了，这就是Pythonic的代码，简洁高效，使用语法糖其实等价于下面显式使用闭包</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">hello_bold <span style="color:#f92672">=</span> makebold(hello)
hello_italic <span style="color:#f92672">=</span> makeitalic(hello)
</code></pre></div><p>装饰器是可以叠加使用的，对于Python中的”@”语法糖，装饰器的调用顺序与使用 @ 语法糖声明的顺序相反</p>
<h4 id="被修饰的函数带参数">被修饰的函数带参数</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">
<span style="color:#f92672">import</span> time
<span style="color:#f92672">import</span> functools

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">clock</span>(func):    
         <span style="color:#a6e22e">@functools.wraps</span>(func)    
          <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">clocked</span>(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):      <span style="color:#75715e">#传入参数与关键字参数</span>
          <span style="color:#e6db74">&#34;&#34;&#34; in wrapper &#34;&#34;&#34;</span>       
          t0 <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()        
          <span style="color:#75715e"># execute        </span>
          result <span style="color:#f92672">=</span> func(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs)        
          
          elapsed <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time() <span style="color:#f92672">-</span> t0        
          
          name <span style="color:#f92672">=</span> func<span style="color:#f92672">.</span>__name__       
          arg_lst <span style="color:#f92672">=</span> []        
          <span style="color:#66d9ef">if</span> args:            
                 arg_lst<span style="color:#f92672">.</span>append(<span style="color:#e6db74">&#39;, &#39;</span><span style="color:#f92672">.</span>join(repr(arg) <span style="color:#66d9ef">for</span> arg <span style="color:#f92672">in</span> args))       
          <span style="color:#66d9ef">if</span> kwargs:           
                 pairs <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">=</span><span style="color:#e6db74">%r</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span> (k, w) <span style="color:#66d9ef">for</span> k, w <span style="color:#f92672">in</span> sorted(kwargs<span style="color:#f92672">.</span>items())]                        arg_lst<span style="color:#f92672">.</span>append(<span style="color:#e6db74">&#39;, &#39;</span><span style="color:#f92672">.</span>join(pairs))       
          arg_str <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;, &#39;</span><span style="color:#f92672">.</span>join(arg_lst)        
          <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;[</span><span style="color:#e6db74">%0.8f</span><span style="color:#e6db74">s] </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">(</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">) -&gt; </span><span style="color:#e6db74">%r</span><span style="color:#e6db74"> &#39;</span> <span style="color:#f92672">%</span> (elapsed, name, arg_str, result))    
          
          <span style="color:#66d9ef">return</span> result    
 <span style="color:#66d9ef">return</span> clocked
 
 <span style="color:#a6e22e">@clock</span>
 <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">snooze</span>(seconds):  
 <span style="color:#e6db74">&#34;&#34;&#34; sleep for seconds &#34;&#34;&#34;</span>   
        time<span style="color:#f92672">.</span>sleep(seconds)
        
 <span style="color:#a6e22e">@clock</span>
 <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">factorial</span>(n):    
 <span style="color:#e6db74">&#34;&#34;&#34; calculate n! &#34;&#34;&#34;</span>    
       <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">if</span> n<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">2</span> <span style="color:#66d9ef">else</span> n<span style="color:#f92672">*</span>factorial(n<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
       
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;*&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">40</span>, <span style="color:#e6db74">&#39;Calling factorial(6)&#39;</span>)
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;6! = &#39;</span>, factorial(<span style="color:#ae81ff">6</span>))


<span style="color:#66d9ef">print</span>(snooze(<span style="color:#ae81ff">5</span>))
<span style="color:#66d9ef">print</span>(snooze<span style="color:#f92672">.</span>__doc__)
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;origin func name is:&#39;</span>, snooze<span style="color:#f92672">.</span>__name__)
</code></pre></div><p>snooze和factorial函数会作为func参数传给clock函数，然后clock函数会返回clocked函数。所以现在factorial保留的是clocked函数的引用。但是这也是装饰器的一个副作用：会把被装饰函数的一些元数据，例如函数名、文档字符串、函数签名等信息覆盖掉。下面会使用functools库中的 @wraps 装饰器来避免这个。</p>
<p><strong>clocked函数做了以下几件事：</strong>
记录初始时间调用原来的factorial函数，
保存结果计算经过的时间
格式化收集的数据，然后打印出来
返回第2步保存的结果</p>
<p><strong>装饰器的典型行为：</strong>
把被装饰的函数体换成新函数，二者接受相同的参数，返回被装饰的函数本该返回的值，同时有额外操作</p>
<p>另外，内嵌包装函数 clocked 添加了functools库中的 @wraps 装饰器，这个装饰器可以把被包装函数的元数据，例如函数名、文档字符串、函数签名等信息保存下来。</p>
<h4 id="参数化装饰器">参数化装饰器</h4>
<p>最外层的函数 logged() 接受参数并将它们作用在内部的装饰器函数上面。 内层的函数 decorate() 接受一个函数作为参数，然后在函数上面放置一个包装器。</p>
<h4 id="装饰器的应用">装饰器的应用</h4>
<h5 id="1-给函数做缓存">1. 给函数做缓存</h5>
<p>第n个斐波那契数来说，是个递归算法，对于这种慢速递归，可以把耗时函数的结果先缓存起来，在调用函数之前先查询一下缓存，如果没有才调用函数</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">
<span style="color:#f92672">from</span> functools <span style="color:#f92672">import</span> wraps
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">memo</span>(func):    
     cache <span style="color:#f92672">=</span> {}    
     miss <span style="color:#f92672">=</span> object()    
     <span style="color:#a6e22e">@wraps</span>(func)    
     <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">wrapper</span>(<span style="color:#f92672">*</span>args):       
           result <span style="color:#f92672">=</span> cache<span style="color:#f92672">.</span>get(args, miss)        
           <span style="color:#66d9ef">if</span> result <span style="color:#f92672">is</span> miss:            
           result <span style="color:#f92672">=</span> func(<span style="color:#f92672">*</span>args)            
           cache[args] <span style="color:#f92672">=</span> result       
           <span style="color:#66d9ef">return</span> result    
           
     <span style="color:#66d9ef">return</span> wrapper
     
<span style="color:#a6e22e">@memo</span>
<span style="color:#a6e22e">@clock</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">fib</span>(n): 
     <span style="color:#66d9ef">if</span> n <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">2</span>:        
          <span style="color:#66d9ef">return</span> n    
     <span style="color:#66d9ef">return</span> fib(n<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>) <span style="color:#f92672">+</span> fib(n<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</code></pre></div><h5 id="2---lrucache">2.   LRUCache</h5>
<p>LRU 算法实现的缓存，在 functools 库里</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">
<span style="color:#f92672">import</span> functools
<span style="color:#a6e22e">@functools.lru_cache</span>()
<span style="color:#a6e22e">@clock</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">fibonacci</span>(n):   
    <span style="color:#66d9ef">if</span> n <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">2</span>:        
         <span style="color:#66d9ef">return</span> n   
   <span style="color:#66d9ef">return</span> fibonacci(n<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>) <span style="color:#f92672">+</span> fibonacci(n<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)<span style="color:#66d9ef">print</span>(fibonacci(<span style="color:#ae81ff">6</span>))
</code></pre></div><h5 id="3给函数输出log">3.给函数输出log</h5>
<h5 id="4数据库的连接">4.数据库的连接</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> pymysql
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ConDb</span>():
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">openClose</span>(fun):
        <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">run</span>(self,sql<span style="color:#f92672">=</span>None):
            <span style="color:#75715e">#创建数据库连接</span>
            db<span style="color:#f92672">=</span>pymysql<span style="color:#f92672">.</span>connect(host<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;localhost&#39;</span>,port<span style="color:#f92672">=</span><span style="color:#ae81ff">3306</span> ,user<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;root&#39;</span>,password<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;root&#39;</span>,db<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;ljj&#39;</span>,charset<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;utf8&#39;</span>)
            <span style="color:#75715e">#创建游标</span>
            cursor <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>cursor()
            <span style="color:#66d9ef">try</span>:
                <span style="color:#75715e">#运行sql语句</span>
                cursor<span style="color:#f92672">.</span>execute(fun(self,sql))
                <span style="color:#75715e">#得到返回值</span>
                li<span style="color:#f92672">=</span>cursor<span style="color:#f92672">.</span>fetchall()
                <span style="color:#75715e">#提交事务</span>
                db<span style="color:#f92672">.</span>commit()
            <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
                <span style="color:#75715e">#如果出现错误，回滚事务</span>
                db<span style="color:#f92672">.</span>rollback()
                <span style="color:#75715e">#打印报错信息</span>
                <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;运行&#39;</span>,str(fun),<span style="color:#e6db74">&#39;方法时出现错误，错误代码：&#39;</span>,e)
            <span style="color:#66d9ef">finally</span>:
                <span style="color:#75715e">#关闭游标和数据库连接</span>
                cursor<span style="color:#f92672">.</span>close()
                db<span style="color:#f92672">.</span>close()
            <span style="color:#66d9ef">try</span>:
                <span style="color:#75715e">#返回sql执行信息</span>
                <span style="color:#66d9ef">return</span> li
            <span style="color:#66d9ef">except</span>:
                <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;没有得到返回值，请检查代码，该信息出现在ConDb类中的装饰器方法&#39;</span>)
        <span style="color:#66d9ef">return</span> run
 
 
    <span style="color:#a6e22e">@openClose</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">runSql</span>(self,sql<span style="color:#f92672">=</span>None):
        <span style="color:#66d9ef">if</span> sql <span style="color:#f92672">is</span> None:
            sql<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;select * from batch&#39;</span>
        <span style="color:#66d9ef">return</span> sql
 
    <span style="color:#a6e22e">@openClose</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">runSql1</span>(self,sql<span style="color:#f92672">=</span>None):
        <span style="color:#66d9ef">return</span> sql
</code></pre></div><h5 id="5-flask路由">5. FLASK路由</h5>
<p>关于flask的入门知识初学者可以结合另一篇博文学习</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> flask <span style="color:#f92672">import</span> Flask
app <span style="color:#f92672">=</span> Flask(__name__)
<span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#34;/&#34;</span>)
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">hello</span>():   
     <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;Hello World!&#34;</span>

<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:    
         app<span style="color:#f92672">.</span>run()
</code></pre></div><h5 id="验证页面登录">验证页面登录</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">login_required</span>(func):
    <span style="color:#a6e22e">@functools.wraps</span>(func) <span style="color:#75715e"># 修饰内层函数，防止当前装饰器去修改被装饰函数的属性</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">inner</span>(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
        <span style="color:#75715e"># 从session获取用户信息，如果有，则用户已登录，否则没有登录</span>
        user_id <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;user_id&#39;</span>)
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;session user_id:&#34;</span>, user_id)
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> user_id:
            <span style="color:#75715e"># WITHOUT_LOGIN是一个常量</span>
            <span style="color:#66d9ef">return</span> jsonify(errcode<span style="color:#f92672">=</span>constants<span style="color:#f92672">.</span>WITHOUT_LOGIN,
                           err<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;用户未登录&#34;</span>)
        <span style="color:#66d9ef">else</span>:
            <span style="color:#75715e"># 已经登录的话 g变量保存用户信息，相当于flask程序的全局变量</span>
            g<span style="color:#f92672">.</span>user_id <span style="color:#f92672">=</span> user_id
            <span style="color:#66d9ef">return</span> func(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs)
    <span style="color:#66d9ef">return</span> inner
    
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a6e22e">@api.route</span>(<span style="color:#e6db74">&#39;/index&#39;</span>)
<span style="color:#a6e22e">@login_required</span> 
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">index</span>(): 
      <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&lt;h1&gt;index&lt;/h1&gt;&#34;</span>
</code></pre></div>
    </div>

    <div class="post-copyright">
             
            <p class="copyright-item">
                <span>Author:</span>
                <span>anfieldqi </span>
                </p>
            
           
             
            <p class="copyright-item">
                    <span>Link:</span>
                    <a href=https://anfieldqi.github.io/2020/python%E8%A3%85%E9%A5%B0%E5%99%A8/>https://anfieldqi.github.io/2020/python%E8%A3%85%E9%A5%B0%E5%99%A8/</span>
            </p>
            
             
            <p class="copyright-item lincese">
                除特别标注，文章采用<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可
            </p>
            
    </div>

  
    <div class="post-tags">
        
            <section>
            <i class="iconfont icon-tag"></i>Tag(s): 
            
            <span class="tag"><a href="https://anfieldqi.github.io/tags/python%E5%9F%BA%E7%A1%80/">
                    #python基础</a></span>
            
            </section>
        
        <section>
                <a href="javascript:window.history.back();">back</a></span> · 
                <span><a href="https://anfieldqi.github.io">home</a></span>
        </section>
    </div>

    <div class="post-nav">
        
        <a href="https://anfieldqi.github.io/2020/shell%E5%AD%A6%E4%B9%A0/" class="prev" rel="prev" title="Shell学习"><i class="iconfont icon-left"></i>&nbsp;Shell学习</a>
         
        
        <a href="https://anfieldqi.github.io/2020/python%E5%B5%8C%E5%A5%97%E5%87%BD%E6%95%B0/" class="next" rel="next" title="Python嵌套函数">Python嵌套函数&nbsp;<i class="iconfont icon-right"></i></a>
        
    </div>

    <div class="post-comment">
          
                 
          
          
<div id="gitalk-container"></div>
<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
<script>
  const gitalk = new Gitalk({
    clientID: '10430486a804bdce5dd3',
    clientSecret: 'b8c2e27fc2de4a7e7f9e80094cebbf2601134eea',
    repo: 'AnfieldQi.github.io',
    owner: 'AnfieldQi',
    admin: ['AnfieldQi'],
    id: location.pathname, 
    distractionFreeMode: false 
  });
  (function() {
    if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
      document.getElementById('gitalk-container').innerHTML = 'Gitalk comments not available by default when the website is previewed locally.';
      return;
    }
    gitalk.render('gitalk-container');
  })();
</script>

    </div>
</article>
          </div>
		   </main>
      <footer class="footer">
    <div class="copyright">
        &copy;
        
        <span itemprop="copyrightYear">2019 - 2020</span>
        
        <span class="with-love">
    	 <i class="iconfont icon-love"></i> 
         </span>
         
            <span class="author" itemprop="copyrightHolder"><a href="https://anfieldqi.github.io">anfieldqi</a> | </span> 
         

         
		  <span>power by <a href="https://gohugo.io/" target="_blank" rel="external nofollow">Hugo</a> </span> 
    </div>
</footer>













    
    
    <script src="/js/vendor_no_gallery.min.js" async=""></script>
    
  



     </div>
  </body>
</html>
