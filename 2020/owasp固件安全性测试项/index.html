<!DOCTYPE html>
<html lang="zh-cn">
  <head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noodp"/>
  <meta name="author" content="anfieldqi">
  
  
  
  <link rel="prev" href="http://119.3.182.211/2020/%E6%A0%88%E6%BA%A2%E5%87%BA%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E8%B7%B5_3/" />
  <link rel="next" href="http://119.3.182.211/2020/%E5%9B%BA%E4%BB%B6%E4%BF%A1%E6%81%AF%E7%86%B5%E8%AE%A1%E7%AE%97/" />
  <link rel="canonical" href="http://119.3.182.211/2020/owasp%E5%9B%BA%E4%BB%B6%E5%AE%89%E5%85%A8%E6%80%A7%E6%B5%8B%E8%AF%95%E9%A1%B9/" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
  <title>
       
       
           OWASP固件安全性测试项 | AnfieldQi`s Blog
       
  </title>
  <meta name="title" content="OWASP固件安全性测试项 | AnfieldQi`s Blog">
    
  
  <link rel="stylesheet" href="/font/iconfont.css">
  <link rel="stylesheet" href="/css/main.min.css">


  
  
 

<script type="application/ld+json">
 "@context" : "http://schema.org",
    "@type" : "BlogPosting",
    "mainEntityOfPage": {
         "@type": "WebPage",
         "@id": "http:\/\/119.3.182.211"
    },
    "articleSection" : "posts",
    "name" : "OWASP固件安全性测试项",
    "headline" : "OWASP固件安全性测试项",
    "description" : "固件安全评估 英文名称 firmware security testing methodology 简称 FSTM 测试流程 id 阶段 描述 1 信息收集 固件的相关技术文档的详细使用说明 2 获取固件 使用本文中介绍的多种办法获取固件 3 分",
    "inLanguage" : "zh-cn",
    "author" : "anfieldqi",
    "creator" : "anfieldqi",
    "publisher": "anfieldqi",
    "accountablePerson" : "anfieldqi",
    "copyrightHolder" : "anfieldqi",
    "copyrightYear" : "2020",
    "datePublished": "2020-05-15 09:50:50 \x2b0800 CST",
    "dateModified" : "2020-05-15 09:50:50 \x2b0800 CST",
    "url" : "http:\/\/119.3.182.211\/2020\/owasp%E5%9B%BA%E4%BB%B6%E5%AE%89%E5%85%A8%E6%80%A7%E6%B5%8B%E8%AF%95%E9%A1%B9\/",
    "wordCount" : "4568",
    "keywords" : [ "固件安全", "AnfieldQi`s Blog"]
}
</script>

</head>

  


  <body class="">
    <div class="wrapper">
        <nav class="navbar">
    
    <div class="top-scroll-bar"></div>
    
    <div class="container">
        <div class="navbar-header header-logo">
        	<a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href="http://119.3.182.211">AnfieldQi`s Blog</a>
        </div>
        <div class="menu navbar-right">
                
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
                <a class="menu-item" href="/categories/" title="">Categories</a>
                
                <a class="menu-item" href="/tags/" title="">Tags</a>
                
                <a class="menu-item" href="/about/" title="">About</a>
                
        </div>
    </div>
</nav>
<nav class="navbar-mobile" id="nav-mobile" style="display: none">
    
        <div class="top-scroll-bar"></div>
    
     <div class="container">
        <div class="navbar-header">
            <div>  <a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href="http://119.3.182.211">AnfieldQi`s Blog</a></div>
            <div class="menu-toggle">
                <span></span><span></span><span></span>
            </div>
        </div>
     
          <div class="menu" id="mobile-menu">
                
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
                <a class="menu-item" href="/categories/" title="">Categories</a>
                
                <a class="menu-item" href="/tags/" title="">Tags</a>
                
                <a class="menu-item" href="/about/" title="">About</a>
                
        </div>
    </div>
</nav>
    	 <main class="main">
          <div class="container">
      		
<article class="post-warp" itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
        <h1 class="post-title" itemprop="name headline">OWASP固件安全性测试项</h1>
        <div class="post-meta">
                Written by <a itemprop="name" href="http://119.3.182.211" rel="author">anfieldqi</a> with ♥ 
                <span class="post-time">
                on <time datetime=2020-05-15 itemprop="datePublished">May 15, 2020</time>
                </span>
                in
                <i class="iconfont icon-folder"></i>
                <span class="post-category">
                        <a href="http://119.3.182.211/categories/iot%E5%AE%89%E5%85%A8/"> IoT安全 </a>
                        
                </span>
                <span class="post-word-count">, 4568 words</span>
        </div>
    </header>
    <div class="post-content">
        

        

        
        
     
          
          
          

          
          
          

          <h2 id="固件安全评估">固件安全评估</h2>
<p>英文名称 firmware security testing methodology 简称 FSTM</p>
<h3 id="测试流程">测试流程</h3>
<table>
<thead>
<tr>
<th>id</th>
<th>阶段</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>信息收集</td>
<td>固件的相关技术文档的详细使用说明</td>
</tr>
<tr>
<td>2</td>
<td>获取固件</td>
<td>使用本文中介绍的多种办法获取固件</td>
</tr>
<tr>
<td>3</td>
<td>分析固件</td>
<td>固件的功能、特性</td>
</tr>
<tr>
<td></td>
<td>提取文件系统</td>
<td>从固件中获取文件系统</td>
</tr>
<tr>
<td></td>
<td>分析文件系统内容</td>
<td>静态分析提取的文件系统的配置文件和二进制文件中的漏洞</td>
</tr>
<tr>
<td>6</td>
<td>仿真固件</td>
<td>模拟固件文件和组件</td>
</tr>
<tr>
<td>7</td>
<td>动态分析</td>
<td>根据固件和应用程序接口进行动态测试</td>
</tr>
<tr>
<td>8</td>
<td>运行时分析</td>
<td>在设备运行时分析编译的二进制文件</td>
</tr>
<tr>
<td>9</td>
<td>二进制利用</td>
<td>利用上述手段发现的漏洞实现命令执行</td>
</tr>
</tbody>
</table>
<h2 id="0x01-信息收集">0x01 信息收集</h2>
<ol>
<li>
<p>收集手法：</p>
<ol>
<li>开源情报（ OSINT：Open source intelligence ）技术手段来获取数据</li>
<li>利用开发团队及其内部产品线获取准确和最新的数据，及其项目设计原理和应用的安全设置，进而判断出与安全风险有关的信息和某些特定功能点</li>
</ol>
</li>
<li>
<p>可以初步收集固件的如下信息：类似社会工程学</p>
<ul>
<li>CPU架构</li>
<li>操作系统平台</li>
<li>引导程序配置</li>
<li>硬件原理图</li>
<li>数据表</li>
<li>代码行估计</li>
<li>源代码存储库位置</li>
<li>第三方组建</li>
<li>开源许可证（GPL）</li>
<li>变更日志</li>
<li>FCC ID</li>
<li>设计和数据流程图</li>
<li>威胁建模</li>
<li>渗透测试报告之类</li>
<li>一些测试平台的测试（Jira、错误赏金平台 bugcrowd 或 hackerone ）</li>
</ul>
</li>
</ol>
<h2 id="0x02-获取固件">0x02 获取固件</h2>
<ul>
<li>
<p>直接从开发团队、制造商/供应商或用户获取</p>
</li>
<li>
<p>使用制造商提供的项目从头编译</p>
</li>
<li>
<p>从供应商的support网站获取</p>
</li>
<li>
<p>从共享平台（Dropbox,box,Google drive）</p>
<p>根据二进制文件扩展名获取</p>
<ul>
<li>从用户为了解决问题而上传固件到论坛、博客，或官方评论中获取</li>
</ul>
</li>
<li>
<p>设备更新进行中间人（<code>MITM</code>）获取</p>
</li>
<li>
<p>云提供商存储位置（如：<code>AWS</code>，全称<code>Amazon Web Services S3 buckets</code>）下载构建版本</p>
</li>
<li>
<p>通过 <code>UART</code>、<code>JTAG</code>、<code>PICit</code>等直接从硬件中提取</p>
</li>
<li>
<p>嗅探“硬件组件中的串行通信”中的更新服务器请求</p>
</li>
<li>
<p>通过移动应用程序中的硬编码接口</p>
</li>
<li>
<p>将固件从引导加载程序（如：U-boot ）转储到闪存或通过tftp的网络转储</p>
</li>
<li>
<p>从主板卸下闪存芯片（如：SPI ）或 MCU，以进行离线分析和数据提取</p>
<ul>
<li>需要相应的芯片编辑器来存储 flash/MCU</li>
</ul>
</li>
</ul>
<p><strong>（这个部分我们主要用到的无非是从硬件中提取和从网络上获取两种渠道，关于如何从硬件中获取，另一篇笔记中已经详细记录了几种可行方法，如果暂不涉及，固件来源暂时不需要考虑）</strong></p>
<h2 id="0x03-分析固件">0x03 分析固件</h2>
<ol>
<li>
<p>获取固件后需要分析其特征信息：固件文件类型、潜在的根文件元数据、固件编译平台，使用</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">file <span style="color:#f92672">&lt;</span>bin<span style="color:#f92672">&gt;</span>  
strings  
strings <span style="color:#f92672">-</span>n5 <span style="color:#f92672">&lt;</span>bin<span style="color:#f92672">&gt;</span>  
binwalk <span style="color:#f92672">&lt;</span>bin<span style="color:#f92672">&gt;</span>  
hexdump <span style="color:#f92672">-</span>C <span style="color:#f92672">-</span>n <span style="color:#ae81ff">512</span> <span style="color:#f92672">&lt;</span>bin<span style="color:#f92672">&gt;</span> <span style="color:#f92672">&gt;</span> hexdump<span style="color:#f92672">.</span>out  
hexdump <span style="color:#f92672">-</span>C <span style="color:#f92672">&lt;</span>bin<span style="color:#f92672">&gt;</span> <span style="color:#f92672">|</span> head <span style="color:#75715e"># might find signatures in header</span>
</code></pre></div><p>(关于这个部分，其他笔记中有相关实验实例)</p>
</li>
<li>
<p>若使用上述方法未提取出有用信息，可能由于以下原因：</p>
<ul>
<li>二进制文件可能是Bare metal（bare metal environment是指直接安装在硬件上的虚拟（不带操作系统）组成的计算机系统或者网路，bare metal一般指我们常说的“裸机”，只提供一个安装了操作系统的机器。）</li>
<li>二进制文件可能仅适用于带有自定义文件系统的实时操作系统（ <code>RTOS</code> ）平台</li>
<li>二进制文件可能是加密的</li>
</ul>
</li>
<li>
<p>判断二进制文件是否加密：（<strong>固件加密解决方案见其他篇</strong>）</p>
<p>通过命令：binwalk -E  判断其熵（熵值越高，所含信息量越大，可能被加密或者压缩的几率越大）</p>
<ul>
<li>低熵：不太可能被加密</li>
<li>高熵：可能被加密（或以某种方式压缩）</li>
</ul>
<p>通过binvis</p>
</li>
</ol>
<h2 id="0x04-提取文件系统">0x04 提取文件系统</h2>
<ol>
<li>固件：一个二进制文件的压缩包，文件系统是其中的一个组件，存储在二进制文件的特定偏移地址中，且有一定大小</li>
<li>文件系统的常见类型：squashfs , ubifs , romfs , rootfs , jffs2 , yaffs2 , cramfs , initramfs</li>
</ol>
<h4 id="1binwalk自动提取">1.binwalk自动提取</h4>
<ol>
<li>
<p>binwalk -ev &lt; bin &gt; ，提取出的文件保存：固件名称/文件系统类型/文件系统内容</p>
</li>
<li>
<p>若是文件的标头没有魔术字节 ，需使用 binwalk查找文件系统的偏移量，然后从二进制文件中分割压缩的文件系统，最后再手动提取出来</p>
<ol>
<li>
<p>使用dd进行分割</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">dd <span style="color:#66d9ef">if</span><span style="color:#f92672">=</span>DIR850L_REVB.bin bs<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> skip<span style="color:#f92672">=</span><span style="color:#ae81ff">1704084</span> of<span style="color:#f92672">=</span>dir.squashfs <span style="color:#75715e"># or</span>
dd <span style="color:#66d9ef">if</span><span style="color:#f92672">=</span>DIR850L_REVB.bin bs<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> skip<span style="color:#f92672">=</span><span style="color:#66d9ef">$((</span><span style="color:#ae81ff">0</span>x1A0094<span style="color:#66d9ef">))</span> of<span style="color:#f92672">=</span>dir.squashfs
</code></pre></div></li>
<li>
<p>再进行提取</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">For squashfs：
        unsquashfs dir.squashfs
CPIO archive files：
        cpio -ivd --no-absolute-filenames -F &lt;bin&gt;
For jffs2 filesystems：
        jefferson rootfsfile.jffs2
For ubifs filesystems with NAND flash：
        ubireader_extract_images -u UBI -s &lt;start_offset&gt; &lt;bin&gt;、ubidump.py &lt;bin&gt;
             
</code></pre></div></li>
</ol>
</li>
</ol>
<h4 id="2-dd命令手动提取">2. DD命令手动提取</h4>
<ol>
<li>
<p>偏移量和文件系统大小信息获取</p>
<ol>
<li>
<p>使用hexdump和grep等工具搜索特征信息判断文件系统开始位置，如：Squashfs文件系统</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#通过hexdump查找 &#34;hsqs&#34; 字符串</span>
hexdump -C binary ｜ grep -i <span style="color:#e6db74">&#39;hsqs&#39;</span>
</code></pre></div></li>
<li>
<p>使用dd命令将从该地址开始到文件末尾的内容全部转储下来</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">dd <span style="color:#66d9ef">if</span><span style="color:#f92672">=</span>binary bs<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> skip<span style="color:#f92672">=</span><span style="color:#ae81ff">92588</span> of<span style="color:#f92672">=</span>rt-n300-fs
</code></pre></div></li>
<li>
<p>通过如上步骤，从二进制文件中获取到文件系统，使用 unsquashfs`查看整个文件系统</p>
</li>
</ol>
<hr>
<p>题外话：DD命令</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">dd：用指定大小的块拷贝一个文件，并在拷贝的同时进行指定的转换。
注意：指定数字的地方若以下列字符结尾，则乘以相应的数字：b<span style="color:#f92672">=</span>512；c<span style="color:#f92672">=</span>1；k<span style="color:#f92672">=</span>1024；w<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>
参数注释：
1. <span style="color:#66d9ef">if</span><span style="color:#f92672">=</span>文件名：输入文件名，缺省为标准输入。即指定源文件。&lt; <span style="color:#66d9ef">if</span><span style="color:#f92672">=</span>input file &gt;
2. of<span style="color:#f92672">=</span>文件名：输出文件名，缺省为标准输出。即指定目的文件。&lt; of<span style="color:#f92672">=</span>output file &gt;
3. ibs<span style="color:#f92672">=</span>bytes：一次读入bytes个字节，即指定一个块大小为bytes个字节。
    obs<span style="color:#f92672">=</span>bytes：一次输出bytes个字节，即指定一个块大小为bytes个字节。
    bs<span style="color:#f92672">=</span>bytes：同时设置读入/输出的块大小为bytes个字节。
4. cbs<span style="color:#f92672">=</span>bytes：一次转换bytes个字节，即指定转换缓冲区大小。
5. skip<span style="color:#f92672">=</span>blocks：从输入文件开头跳过blocks个块后再开始复制。
6. seek<span style="color:#f92672">=</span>blocks：从输出文件开头跳过blocks个块后再开始复制。
注意：通常只用当输出文件是磁盘或磁带时才有效，即备份到磁盘或磁带时才有效。
7. count<span style="color:#f92672">=</span>blocks：仅拷贝blocks个块，块大小等于ibs指定的字节数。
</code></pre></div><hr>
</li>
</ol>
<h2 id="0x05-分析文件系统内容">0x05 分析文件系统内容</h2>
<h3 id="1手动分析">1.手动分析</h3>
<p>可以分析以下几个方面：（分析方法见其他篇）</p>
<ul>
<li><input disabled="" type="checkbox"> 不安全网络守护程序，如：telnetd（有时会伪装成重命名二进制文件）</li>
<li><input disabled="" type="checkbox"> 硬编码凭证（用户名、密码、API密钥、SSH密钥和后门变体）</li>
<li><input disabled="" type="checkbox"> 硬编码的API端点和后端服务器详细信息</li>
<li><input disabled="" type="checkbox"> 更新可用作入口点的服务器功能</li>
<li><input disabled="" type="checkbox"> 查看未编译的代码并启动脚本以执行远程代码</li>
<li><input disabled="" type="checkbox"> 提取已编译的二进制文件，使用反汇编程序脱机分析</li>
</ul>
<h3 id="2自动分析">2.自动分析</h3>
<h4 id="21trommel">2.1Trommel</h4>
<ol>
<li>
<p>项目地址：https://github.com/CERTCC/trommel</p>
</li>
<li>
<p>功能：开源项目，核心原理为自动对整个文件系统的所有文件进行遍历，正则匹配相关检测项的特征字符串</p>
</li>
<li>
<p>检测项：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">安全外壳（SSH）密钥文件
安全套接字层（SSL）密钥文件
互联网协议（IP）地址
统一资源定位符（URL）
电子邮件地址
外壳脚本
Web服务器二进制文件
配置文件
数据库文件
特定的二进制文件（即Dropbear，BusyBox等）
共享对象库文件
Web应用程序脚本变量，以及
Android应用程序包（APK）文件权限
</code></pre></div></li>
</ol>
<h4 id="22-firmwalker">2.2 firmwalker</h4>
<ol>
<li>
<p>项目地址：https://github.com/craigz28/firmwalker</p>
</li>
<li>
<p>功能：搜索提取或安装的固件文件系统</p>
</li>
<li>
<p>检测项：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">etc / shadow和etc / passwd
列出etc / ssl目录
搜索与SSL相关的文件，例如.pem，.crt等。
搜索配置文件
寻找脚本文件
搜索其他.bin文件
查找诸如admin，password，remote等的关键字。
搜索物联网设备上使用的通用Web服务器
搜索常见的二进制文件，例如ssh，tftp，dropbear等。
搜索URL，电子邮件地址和IP地址
实验性支持，可使用Shodan CLI调用Shodan API
</code></pre></div></li>
<li>
<p>使用：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">1.firmwalk 分析文件系统需使用绝对路径：
./firmwalker.sh /home/embedos/firmware/_IoTGoat-rpi-2.img.extracted/squashfs-root/
2.分析结果如下：分析结果存储在 /data/ 目录下的两个文件：firmwalker.txt 和 firmwalkerappsec.txt，需手动检查这些文件。
</code></pre></div></li>
</ol>
<h4 id="23-fact">2.3 FACT</h4>
<ol>
<li>
<p>项目地址：https://github.com/fkie-cad/FACT_core</p>
</li>
<li>
<p>功能：固件分析比较工具包</p>
</li>
<li>
<p>检测项：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">标识软件组件（如：操作系统、CPU体系结构和第三方组件）及其关联的版本信息
从映像中提取固件文件系统
检测证书和私钥
检测CWE
基于提要和签名的漏洞检测
基于静态行为分析
固件版本和文件的比较（差异）
使用QEMU对文件系统中的二进制文件进行用户仿真
缓冲区溢出防护机制 NX, DEP, ASLR, stack canaries, RELRO, and FORTIFY_SOURCE
REST API
</code></pre></div></li>
</ol>
<h4 id="24二进制文件分析">2.4二进制文件分析</h4>
<ol>
<li>
<p>工具： <code>IDA Pro</code>、<code>Ghidra</code>、<code>Hopper</code>、<code>Capstone</code> 或 <code>binary Ninja</code> （使用方法自查）</p>
</li>
<li>
<p>二进制文件选取及分析内容：可以选择从 <code>FACT</code> 获取的可疑内容，或针对漏洞利用点进行查找分析</p>
<p>（系统调用、字符串、函数列表、易产生内存损坏，对 system()`或类似函数调用）</p>
</li>
<li>
<p>分析二进制文件的常见功能点：</p>
<p>自动检测下面这些所提到的文件：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">./checksec --file<span style="color:#f92672">=</span>/home/embedos/firmware/_IoTGoat-x86-generic-combined-squashfs.img.extracted/squashfs-root/bin/busybox
   
./checksec --file<span style="color:#f92672">=</span>/home/embedos/firmware/_IoTGoat-x86-generic-combined-squashfs.img.extracted/squashfs-root/usr/bin/shellback
</code></pre></div><ol>
<li>
<p>是否启用 <strong>Stack canaries</strong>（堆栈保护机制）</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">readelf -aW bin/*| grep stack_chk_fail
mips-buildroot-linux-uclibc-objdump -d bin/binary | grep stack_chk_fail
</code></pre></div></li>
<li>
<p>是否启用 Non-executable (NX) （应该是一种<strong>数据保护 DEP</strong>）</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">readelf -lW bin/&lt;bin&gt;| grep STACK
</code></pre></div><p>从结果中判断堆栈是否可执行，<code>E</code> 代表可执行</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">GNU_STACK 0x000000 0x00000000 0x00000000 0x00000 0x00000 RWE 0x4
</code></pre></div><p>执行：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">execstack bin/*
bin/ash
bin/busybox
</code></pre></div></li>
<li>
<p>是否启用**Position-independent executable (PIE)**地址无关可执行文件</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#PIE disabled</span>
readelf -h &lt;bin&gt; | grep -q <span style="color:#e6db74">&#39;Type:[[:space:]]*EXEC&#39;</span>
<span style="color:#75715e">#PIE enabled</span>
readelf -h &lt;bin&gt; | grep <span style="color:#e6db74">&#39;Type:[[:space:]]*DYN&#39;</span>
</code></pre></div></li>
<li>
<p>DSO（dynamic shared ob ject）动态共享目标文件</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">readelf -d &lt;bin&gt; | grep -q <span style="color:#e6db74">&#39;DEBUG&#39;</span>
</code></pre></div></li>
<li>
<p>Symbols 动态链接库和符号</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">readelf --syms &lt;bin&gt;
nm &lt;bin&gt;
</code></pre></div></li>
<li>
<p><strong>RELRO</strong> ( RELocation Read-Only，只读重定位)（一种用于加强对二进制数据段的保护技术）配置</p>
<pre><code>#完整RELRO
readelf -d binary | grep BIND_NOW
#部分RELRO
readelf -d binary | grep GNU_RELRO
</code></pre></li>
</ol>
</li>
</ol>
<hr>
<p>对于 Microsoft 二进制文件（EXE、DLL），使用 <a href="https://github.com/NetSPI/PESecurity">PESecurity</a> 检查 ASLR, DEP, SafeSEH, StrongNaming, Authenticode, Control Flow Guard 和 HighEntropyVA(暂未尝试)</p>
<hr>
<h3 id="0x06-仿真固件">0x06 仿真固件</h3>
<p>为了确定及验证详细信息、线索、潜在的漏洞，必需模拟固件及其封装的二进制文件</p>
<h4 id="1部分仿真">1.部分仿真</h4>
<ol>
<li>
<p>获取目标的 CPU 架构和字节序，然后选择适当的 QEMU 仿真二进制文件</p>
</li>
<li>
<p>CPU架构获取</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">binwalk -Y &lt;bin&gt; 
readelf -h &lt;bin&gt;
</code></pre></div></li>
<li>
<p>字节序的获取(el 代表： little endian ，eb 代表：big endian)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">binwalk -Y UPG_ipc8120p-w7-M20-hi3516c-20160328_165229.ov
</code></pre></div></li>
<li>
<p>选择合适的QEMU 二进制文件来执行部分仿真（<strong>从固件提取的文件系统中的二进制文件：/usr/bin/shellback</strong>）</p>
<ol>
<li>
<p>QEMU 二进制文件通常所在目录：/usr/local/qemu-arch 或/usr/bin/qemu-arch</p>
</li>
<li>
<p><strong>将 QEMU 二进制文件复制到提取的文件系统的根目录中</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">cd _DIR850L_REVB_FW207WWb05_h1ke_beta1.decrypted.extracted/squashfs-root 
cp /usr/bin/qemu-arm-static .
</code></pre></div></li>
<li>
<p>使用 QEMU 和 chroot 进行仿真</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">sudo chroot . ./qemu-arch &lt;binarytoemulate&gt;
</code></pre></div></li>
</ol>
</li>
</ol>
<h4 id="2部分仿真实例">2.部分仿真实例</h4>
<ol>
<li>
<p><strong>busybox</strong>: sudo chroot . ./qemu-arm-static bin/busybox ls</p>
</li>
<li>
<p><strong>shellback 开启5515上的侦听服务</strong>:sudo chroot . ./qemu-arm-static usr/bin/shellback</p>
</li>
<li>
<p><strong>使用 netcat 尝试连接该服务</strong>:sudo lsof -i:5515   nc -nv 127.0.0.1 5515</p>
</li>
<li>
<p><strong>MIPS CGI 二进制文件，向该文件发出POST请求</strong>:</p>
<p>sudo chroot . ./qemu-mips-static -E REQUEST_METHOD=&quot;POST&rdquo; -E REQUEST_URI=&lt;request_uri&gt; -E REMOTE_ADDR=&lt;ip_addr&gt; -E HTTP_COOKIE=&lt;custom_cookie&gt; -g <!-- raw HTML omitted --> <!-- raw HTML omitted --></p>
</li>
</ol>
<h4 id="3-全仿真服务">3. 全仿真服务</h4>
<ol>
<li>
<p>使用自动化工具来进行固件的完整仿真</p>
</li>
<li>
<p>工具:(具体使用见其他)</p>
<table>
<thead>
<tr>
<th>TOOL</th>
<th>LINK</th>
</tr>
</thead>
<tbody>
<tr>
<td>firmware-analysis-toolkit</td>
<td><a href="https://github.com/attify/firmware-analysis-toolkit">https://github.com/attify/firmware-analysis-toolkit</a></td>
</tr>
<tr>
<td>armx</td>
<td><a href="https://github.com/therealsaumil/armx/">https://github.com/therealsaumil/armx/</a></td>
</tr>
<tr>
<td>firmadyne</td>
<td><a href="https://github.com/firmadyne/firmadyne">https://github.com/firmadyne/firmadyne</a></td>
</tr>
<tr>
<td>qltool</td>
<td><a href="https://github.com/qilingfr%20amework/qiling#qltool">https://github.com/qilingfr%20amework/qiling#qltool</a></td>
</tr>
</tbody>
</table>
</li>
</ol>
<h3 id="0x07-动态分析">0x07 动态分析</h3>
<h3 id="0x08-运行时分析">0x08 运行时分析</h3>
<h3 id="0x09-漏洞利用">0x09 漏洞利用</h3>
<ol>
<li>
<p>通过上面阶段的测试识别出漏洞之后，需使用PoC在真实环境中进行验证。编写漏洞利用代码需要掌握低级语言（如：ASM、C/C++、shellcode 等）的编程及了解一些目标体系结构（如：MIPS、ARM、x86等）</p>
</li>
<li>
<p>在遇到二进制缓解（保护）机制（eg：NX、DEP、ASLR等）时，需要其他技术进行恶意攻击，比如：、</p>
<ul>
<li>面向返回的编程：ROP（Return-oriented Programming），ROP 允许攻击者通过链接目标进程或二进制代码中现有的代码实施恶意攻击，利用ROP 的漏洞举例：通过 ROP 链进行缓冲区溢出。可借助工具 Capstone’s gadget finder或者 <a href="https://github.com/JonathanSalwan/ROPgadget">ROPGadget</a> 。</li>
</ul>
</li>
</ol>
<h4 id="1-固件和二进制文件分析工具">1. 固件和二进制文件分析工具</h4>
<ul>
<li><a href="https://github.com/fkie-cad/FACT_core">Firmware Analysis Comparison Toolkit(FACT)</a></li>
<li><a href="https://github.com/cruise-automation/fwanalyzer">FWanalyzer</a></li>
<li><a href="https://github.com/craigz28/firmwalker">Firmwalker</a></li>
<li><a href="https://code.google.com/archive/p/firmware-mod-kit/">Firmware Modification Kit</a></li>
<li><a href="https://github.com/firmadyne/firmadyne">Firmadyne</a></li>
<li><a href="https://gitlab.com/bytesweep/bytesweep">ByteSweep</a></li>
<li><a href="http://binwalk.org/">Binwalk</a></li>
<li><a href="https://www.flashrom.org/Flashrom">Flashrom</a></li>
<li><a href="http://openocd.org/">Openocd</a></li>
<li><a href="https://github.com/angr/angr">Angr binary analysis framework</a></li>
<li><a href="http://www.binaryanalysis.org/en/home">Binary Analysis Tool</a></li>
<li><a href="https://github.com/slimm609/checksec.sh">Checksec.sh</a></li>
<li><a href="https://github.com/chipsec/chipsec">CHIPSEC</a></li>
<li>[Qiling Advanced Binary Emulation framework](<a href="https://github.com/qilingfr">https://github.com/qilingfr</a> amework/qiling)</li>
<li><a href="https://triton.quarkslab.com/">Triton dynamic binary analysis (DBA) framework</a></li>
</ul>
<h4 id="2-用于练习的固件项目">2. 用于练习的固件项目</h4>
<ul>
<li><a href="https://github.com/OWASP/IoTGoat">OWASP IoTGoat</a></li>
<li><a href="https://github.com/praetorian-code/DVRF">The Damn Vulnerable Router Firmware Project</a></li>
<li><a href="https://blog.exploitlab.net/2018/01/dvar-damn-vulnerable-arm-router.html">Damn Vulnerable ARM Router (DVAR)</a></li>
<li><a href="https://github.com/therealsaumil/armx#downloads">ARM-X</a></li>
<li><a href="https://azeria-labs.com/lab-vm-2-0/">Azeria Labs VM 2.0</a></li>
</ul>
<h4 id="license"><strong>License</strong></h4>
<p>[Creative Commons Attribution Share Alike 4.0 International](<a href="https://github.com/sc">https://github.com/sc</a> riptingxss/owasp-fstm/blob/master/License.md)</p>
<hr>
<ol>
<li>
<p>来源：https://scriptingxss.gitbook.io/firmware-security-testing-methodology/#stage-3-analyzing-firmware</p>
</li>
<li>
<p>转载：https://www.anquanke.com/post/id/202942</p>
</li>
<li>
<p>参考：白帽汇,掘金</p>
</li>
</ol>
<hr>

    </div>

    <div class="post-copyright">
             
            <p class="copyright-item">
                <span>Author:</span>
                <span>anfieldqi </span>
                </p>
            
           
             
            <p class="copyright-item">
                    <span>Link:</span>
                    <a href=http://119.3.182.211/2020/owasp%E5%9B%BA%E4%BB%B6%E5%AE%89%E5%85%A8%E6%80%A7%E6%B5%8B%E8%AF%95%E9%A1%B9/>http://119.3.182.211/2020/owasp%E5%9B%BA%E4%BB%B6%E5%AE%89%E5%85%A8%E6%80%A7%E6%B5%8B%E8%AF%95%E9%A1%B9/</span>
            </p>
            
             
            <p class="copyright-item lincese">
                除特别标注，文章采用<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可
            </p>
            
    </div>

  
    <div class="post-tags">
        
            <section>
            <i class="iconfont icon-tag"></i>Tag(s): 
            
            <span class="tag"><a href="http://119.3.182.211/tags/%E5%9B%BA%E4%BB%B6%E5%AE%89%E5%85%A8/">
                    #固件安全</a></span>
            
            </section>
        
        <section>
                <a href="javascript:window.history.back();">back</a></span> · 
                <span><a href="http://119.3.182.211">home</a></span>
        </section>
    </div>

    <div class="post-nav">
        
        <a href="http://119.3.182.211/2020/%E6%A0%88%E6%BA%A2%E5%87%BA%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E8%B7%B5_3/" class="prev" rel="prev" title="3.栈溢出原理与实践"><i class="iconfont icon-left"></i>&nbsp;3.栈溢出原理与实践</a>
         
        
        <a href="http://119.3.182.211/2020/%E5%9B%BA%E4%BB%B6%E4%BF%A1%E6%81%AF%E7%86%B5%E8%AE%A1%E7%AE%97/" class="next" rel="next" title="固件信息熵计算">固件信息熵计算&nbsp;<i class="iconfont icon-right"></i></a>
        
    </div>

    <div class="post-comment">
          
                 
          
          
<div id="gitalk-container"></div>
<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
<script>
  const gitalk = new Gitalk({
    clientID: '10430486a804bdce5dd3',
    clientSecret: 'b8c2e27fc2de4a7e7f9e80094cebbf2601134eea',
    repo: 'AnfieldQi.github.io',
    owner: 'AnfieldQi',
    admin: ['AnfieldQi'],
    id: location.pathname, 
    distractionFreeMode: false 
  });
  (function() {
    if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
      document.getElementById('gitalk-container').innerHTML = 'Gitalk comments not available by default when the website is previewed locally.';
      return;
    }
    gitalk.render('gitalk-container');
  })();
</script>

    </div>
</article>
          </div>
		   </main>
      <footer class="footer">
    <div class="copyright">
        &copy;
        
        <span itemprop="copyrightYear">2019 - 2020</span>
        
        <span class="with-love">
    	 <i class="iconfont icon-love"></i> 
         </span>
         
            <span class="author" itemprop="copyrightHolder"><a href="http://119.3.182.211">anfieldqi</a> | </span> 
         

         
            <a href="http://www.beian.miit.gov.cn/" target="_blank" rel="external nofollow">京ICP备20032128号 </a> |
         
		  <span>power by <a href="https://gohugo.io/" target="_blank" rel="external nofollow">Hugo</a> </span> 
    </div>
</footer>













    
    
    <script src="/js/vendor_no_gallery.min.js" async=""></script>
    
  



     </div>
  </body>
</html>
